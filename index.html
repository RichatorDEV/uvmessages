<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>UV Messages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
        .sidebar { 
            height: 100%; width: 0; position: fixed; top: 0; left: 0; 
            background: #2c3e50; overflow-x: hidden; transition: 0.5s; padding-top: 60px; 
        }
        .sidebar a, .sidebar button { 
            padding: 10px 15px; display: block; color: white; text-decoration: none; border: none; background: none; width: 100%; text-align: left; cursor: pointer; 
        }
        .sidebar a:hover, .sidebar button:hover { background: #34495e; }
        .main { margin-left: 0; transition: 0.5s; padding: 20px; }
        .openbtn { font-size: 20px; cursor: pointer; background: #2c3e50; color: white; padding: 10px 15px; border: none; position: fixed; top: 10px; left: 10px; display: none; }
        .auth-section, .messaging-section, .settings-section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; }
        .hidden { display: none; }
        .contacts { margin-top: 20px; }
        .contact { display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .contact:hover { background: #f0f0f0; }
        .contact img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .messages { margin-top: 20px; height: 400px; overflow-y: auto; }
        .message { display: flex; align-items: center; padding: 10px; margin: 5px 0; background: #e9ecef; border-radius: 5px; }
        .message img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div id="sidebar" class="sidebar hidden">
        <a href="#" onclick="showMessaging()">Mensajería</a>
        <a href="#" onclick="showSettings()">Configuración</a>
        <button onclick="logout()">Cerrar Sesión</button>
    </div>

    <div id="main" class="main">
        <button id="openbtn" class="openbtn" onclick="toggleSidebar()">☰</button>

        <!-- Sección de autenticación -->
        <div class="auth-section" id="authSection">
            <h2>UV Messages</h2>
            <div id="registerForm">
                <h3>Registro</h3>
                <input type="text" id="regUsername" placeholder="Nombre de usuario"><br>
                <input type="password" id="regPassword" placeholder="Contraseña"><br>
                <button onclick="register()">Registrar</button>
            </div>
            <div id="loginForm">
                <h3>Iniciar Sesión</h3>
                <input type="text" id="loginUsername" placeholder="Nombre de usuario"><br>
                <input type="password" id="loginPassword" placeholder="Contraseña"><br>
                <button onclick="login()">Iniciar Sesión</button>
            </div>
            <p id="authMessage"></p>
        </div>

        <!-- Sección de mensajería -->
        <div class="messaging-section hidden" id="msgSection">
            <h2>Bienvenido <span id="currentUser"></span></h2>
            <p>ID: <span id="userId"></span></p>
            <input type="text" id="newContact" placeholder="Agregar contacto (nombre de usuario)"><br>
            <button onclick="addContact()">Agregar Contacto</button>
            <p id="contactStatus"></p>
            <div class="contacts" id="contacts"></div>
            <div class="messages" id="messages"></div>
            <textarea id="messageContent" placeholder="Escribe tu mensaje"></textarea><br>
            <button onclick="sendMessage()">Enviar Mensaje</button>
            <p id="messageStatus"></p>
        </div>

        <!-- Sección de configuración -->
        <div class="settings-section hidden" id="settingsSection">
            <h2>Configuración</h2>
            <input type="text" id="displayName" placeholder="Nuevo nombre visible"><br>
            <input type="file" id="profilePicture" accept="image/*"><br>
            <button onclick="updateProfile()">Actualizar Perfil</button>
            <p id="settingsStatus"></p>
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedContact = null;

        // Restaurar sesión al cargar la página
        window.onload = function() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('msgSection').classList.remove('hidden');
                document.getElementById('openbtn').style.display = 'block';
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('currentUser').textContent = currentUser.displayName;
                document.getElementById('userId').textContent = currentUser.id;
                loadContacts();
            }
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            if (sidebar.style.width === '250px') {
                sidebar.style.width = '0';
                main.style.marginLeft = '0';
            } else {
                sidebar.style.width = '250px';
                main.style.marginLeft = '250px';
            }
        }

        function showMessaging() {
            document.getElementById('msgSection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
        }

        function showSettings() {
            document.getElementById('msgSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.remove('hidden');
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const messageElement = document.getElementById('authMessage');

            if (!username || !password) {
                messageElement.textContent = 'Por favor, completa ambos campos';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                console.log('Registro:', data);
                messageElement.textContent = data.message + (data.userId ? `. Tu ID es: ${data.userId}` : '');
            } catch (error) {
                console.error('Error al registrar:', error);
                messageElement.textContent = 'Error al conectar con el servidor';
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const messageElement = document.getElementById('authMessage');

            if (!username || !password) {
                messageElement.textContent = 'Por favor, completa ambos campos';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                console.log('Login:', data);

                if (response.ok) {
                    currentUser = { 
                        id: data.userId, 
                        username: data.username, 
                        displayName: data.displayName || data.username, 
                        profilePicture: data.profilePicture || 'https://via.placeholder.com/40' 
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Guardar en localStorage
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('msgSection').classList.remove('hidden');
                    document.getElementById('openbtn').style.display = 'block';
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = currentUser.displayName;
                    document.getElementById('userId').textContent = currentUser.id;
                    await loadContacts();
                } else {
                    messageElement.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                messageElement.textContent = 'Error al conectar con el servidor';
            }
        }

        function logout() {
            currentUser = null;
            selectedContact = null;
            localStorage.removeItem('currentUser'); // Eliminar de localStorage
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('msgSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('openbtn').style.display = 'none';
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('sidebar').style.width = '0';
            document.getElementById('main').style.marginLeft = '0';
            document.getElementById('authMessage').textContent = '';
            document.getElementById('contactStatus').textContent = '';
            document.getElementById('messageStatus').textContent = '';
        }

        async function addContact() {
            if (!currentUser) return;

            const contactId = document.getElementById('newContact').value;
            const statusElement = document.getElementById('contactStatus');

            if (!contactId) {
                statusElement.textContent = 'Ingresa un nombre de usuario';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, contactId })
                });
                const data = await response.json();
                console.log('Respuesta de agregar contacto:', data);

                if (response.ok) {
                    statusElement.textContent = 'Contacto agregado';
                    document.getElementById('newContact').value = '';
                    await loadContacts();
                } else {
                    statusElement.textContent = `Error: ${data.message} ${data.error || ''}`;
                }
            } catch (error) {
                console.error('Error al agregar contacto:', error);
                statusElement.textContent = 'Error al conectar con el servidor';
            }
        }

        async function loadContacts() {
            if (!currentUser) return;

            try {
                const response = await fetch(`http://localhost:3000/api/contacts/${currentUser.id}`);
                const contacts = await response.json();
                console.log('Contactos cargados:', contacts);
                const contactsDiv = document.getElementById('contacts');
                contactsDiv.innerHTML = '';

                if (!Array.isArray(contacts)) {
                    throw new Error('Respuesta no es un array');
                }

                contacts.forEach(contact => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact';
                    contactElement.innerHTML = `
                        <img src="${contact.profilePicture || 'https://via.placeholder.com/40'}" alt="${contact.displayName}">
                        <span>${contact.displayName}</span>
                    `;
                    contactElement.onclick = () => {
                        selectedContact = contact.id;
                        updateMessages();
                    };
                    contactsDiv.appendChild(contactElement);
                });
            } catch (error) {
                console.error('Error al cargar contactos:', error);
                document.getElementById('contactStatus').textContent = 'Error al cargar contactos: ' + error.message;
            }
        }

        async function sendMessage() {
            if (!currentUser || !selectedContact) {
                document.getElementById('messageStatus').textContent = 'Selecciona un contacto primero';
                return;
            }

            const content = document.getElementById('messageContent').value;
            const messageStatus = document.getElementById('messageStatus');

            if (!content) {
                messageStatus.textContent = 'Escribe un mensaje';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ senderId: currentUser.id, recipientId: selectedContact, content })
                });
                const data = await response.json();
                console.log('Respuesta de enviar mensaje:', data);

                if (response.ok) {
                    messageStatus.textContent = 'Mensaje enviado';
                    document.getElementById('messageContent').value = '';
                    await updateMessages();
                } else {
                    messageStatus.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                messageStatus.textContent = 'Error al conectar con el servidor';
            }
        }

        async function updateMessages() {
            if (!currentUser || !selectedContact) return;

            try {
                const response = await fetch(`http://localhost:3000/api/messages/${currentUser.id}/${selectedContact}`);
                const messages = await response.json();
                console.log('Mensajes cargados:', messages);
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                messages.forEach(msg => {
                    const msgElement = document.createElement('div');
                    msgElement.className = 'message';
                    msgElement.innerHTML = `
                        <img src="${msg.profilePicture || 'https://via.placeholder.com/30'}" alt="${msg.displayName}">
                        <span>${msg.displayName}: ${msg.content} (${new Date(msg.timestamp).toLocaleString()})</span>
                    `;
                    messagesDiv.appendChild(msgElement);
                });
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
            }
        }

        async function updateProfile() {
            if (!currentUser) return;

            const displayName = document.getElementById('displayName').value;
            const profilePicture = document.getElementById('profilePicture').files[0];
            const statusElement = document.getElementById('settingsStatus');

            if (!displayName && !profilePicture) {
                statusElement.textContent = 'Ingresa un nombre o selecciona una foto';
                return;
            }

            const formData = new FormData();
            formData.append('userId', currentUser.id);
            if (displayName) formData.append('displayName', displayName);
            if (profilePicture) formData.append('profilePicture', profilePicture);

            try {
                const response = await fetch('http://localhost:3000/api/profile', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                console.log('Respuesta de actualizar perfil:', data);

                if (response.ok) {
                    statusElement.textContent = 'Perfil actualizado';
                    if (displayName) currentUser.displayName = displayName;
                    if (profilePicture) currentUser.profilePicture = `/uploads/${profilePicture.name}`;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Actualizar localStorage
                    document.getElementById('currentUser').textContent = currentUser.displayName;
                    await loadContacts();
                } else {
                    statusElement.textContent = `Error: ${data.message} ${data.error || ''}`;
                }
            } catch (error) {
                console.error('Error al actualizar perfil:', error);
                statusElement.textContent = 'Error al conectar con el servidor';
            }
        }

        setInterval(() => {
            if (currentUser && selectedContact) updateMessages();
        }, 5000);
    </script>
</body>
</html>